<!DOCTYPE html>

<!--
---
layout: default
title: GraphQL/Leaflet
nav_order: 10
parent: Demos
---
-->

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphQL Map Display</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            display: flex;
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: Arial, sans-serif;
        }

        #sidebar {
            /* width: 500px; */
            width: 40%;
            padding: 15px;
            background: #f8f8f8;
            border-right: 1px solid #ddd;
            overflow: auto;
            resize: horizontal;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        textarea {
            width: 100%;
            height: 500px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 14px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <h3>Edit GraphQL Query</h3>
        <textarea id="graphqlQuery"></textarea>
        <button id="updateMap">Update Map</button>
	<button id="loadSimpleExample">Load Simple Example</button>
	<button id="loadComplexExample">Load Complex Example</button>
    </div>
    <div id="map"></div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Your custom script -->
<!--     <script src="script.js"></script> -->
    <script>
// GraphQL endpoint URL
// const GRAPHQL_URL = 'http://localhost:8642/graphql';
const GRAPHQL_URL = 'https://rpt.demo.aksw.org/graphql';

// GraphQL query

const simpleQuery = `
{
  locations(limit: 10)
      @pattern(of: "?s a coy:Country", from: "s", to: "s")
      @prefix(name: "rdfs", iri: "http://www.w3.org/2000/01/rdf-schema#")
      @prefix(name: "geo", iri: "http://www.opengis.net/ont/geosparql#")
      @prefix(name: "geof", iri: "http://www.opengis.net/def/function/geosparql/")
      @prefix(name: "norse", iri: "https://w3id.org/aksw/norse#")
      @prefix(name: "coy", iri: "https://schema.coypu.org/global#")
    {
      label @one
          @pattern(of: """
            SELECT ?s ?o {
              ?s rdfs:label ?o .
              FILTER(langMatches(lang(?o), 'en'))
            }
            """, from: "s", to: "o")

      geometry @one
          @pattern(of: """
            ?s geo:hasGeometry/geo:asWKT ?x .
            BIND(STRDT(STR(geof:asGeoJSON(?x)), norse:json) AS ?o)
            """, from: "s", to: "o")
    }
}
`;

const complexQuery = `
{
  locations(limit: 1000)
      @pattern(of: "?s a coy:Country", from: "s", to: "s")
      @prefix(name: "", iri: "https://schema.coypu.org/global#")
      @prefix(name: "rdfs", iri: "http://www.w3.org/2000/01/rdf-schema#")
      @prefix(name: "geo", iri: "http://www.opengis.net/ont/geosparql#")
      @prefix(name: "geof", iri: "http://www.opengis.net/def/function/geosparql/")
      @prefix(name: "norse", iri: "https://w3id.org/aksw/norse#")
      @prefix(name: "afn", iri: "http://jena.apache.org/ARQ/function#")
      @prefix(name: "coy", iri: "https://schema.coypu.org/global#")
    {
      label @one
          @pattern(of: """
            SELECT ?s ?o {
              ?s rdfs:label ?o .
              FILTER(langMatches(lang(?o), 'en'))
            }
            """, from: "s", to: "o")

      features
          @pattern(of: """
            SELECT * {
              {
                ?s ?p ?o .
                FILTER(?p NOT IN (rdfs:label))
              }
              # Auto-derive property cardinalities from all data
              { SERVICE <cache:> {
                  { SELECT ?p (MAX(?c) AS ?pc) {
                    SELECT ?x ?p (COUNT(*) AS ?c) {
                     ?x ?p ?z
                    } GROUP BY ?x ?p
                  } GROUP BY ?p }
                }
              }
            }
            """, from: "s", to: "o")
          @index(by: "afn:localname(?p)", oneIf: "?pc = 1")

      geometry @one
          @pattern(of: """
            ?s geo:hasGeometry/geo:asWKT ?x .
            BIND(STRDT(STR(geof:asGeoJSON(
              geof:simplifyDp(?x, 0.2)
            )), norse:json) AS ?o)
            """, from: "s", to: "o")
    }
}
`;

/**
There is currently a bug with variable analysis which breaks indexing labels by language...
      #label @pattern(of: "?s rdfs:label ?o", from: "s", to: "o") @one {
      #  labelByLang @pattern(of: "BIND(?x AS ?y)", from: "x", to: "y") # @index(by: "lang(?y)", oneIf: "true") @one
      #}
*/

const initialQuery = simpleQuery;


// Initialize the Leaflet map
const map = L.map('map').setView([0, 0], 2);

// Add a base layer (OpenStreetMap)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Fetch data from the GraphQL API
async function fetchData(query) {
    const response = await fetch(GRAPHQL_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query })
    });

    const json = await response.json();
    const locations = json.data.locations;
    return locations;
}

// Function to create HTML for the popup with all JSON keys and values
function createPopupContent(location) {
    let content = '<b>Location Details:</b><br>';
    for (const key in location) {
        if (location.hasOwnProperty(key) && key !== 'geometry') { // Exclude geometry from popup
            content += `<b>${key}:</b> ${location[key]}<br>`;
        }
    }
    return content;
}

// Add data to the map
async function addDataToMap() {
    const query = document.getElementById('graphqlQuery').value;
    const locations = await fetchData(query);

    // Clear existing map layers
    map.eachLayer((layer) => {
        if (layer instanceof L.GeoJSON) {
            map.removeLayer(layer);
        }
    });

    locations.forEach(location => {
        L.geoJSON(location.geometry, {
            onEachFeature: (feature, layer) => {
                const popupContent = createPopupContent(location);
                layer.bindPopup(popupContent);
            }
        }).addTo(map);
    });
}

document.getElementById('graphqlQuery').value = initialQuery;

// Event listener for the "Update Map" button
document.getElementById('updateMap').addEventListener('click', () => {
    addDataToMap();
});


document.getElementById('loadSimpleExample').addEventListener('click', () => {
    document.getElementById('graphqlQuery').value = simpleQuery;
    addDataToMap();
});

document.getElementById('loadComplexExample').addEventListener('click', () => {
    document.getElementById('graphqlQuery').value = complexQuery;
    addDataToMap();
});



// Load the map data
addDataToMap(initialQuery);

    </script>
</body>

</html>

